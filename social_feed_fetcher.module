<?php

/**
 * @file
 * Social Feed Fetcher Module.
 */

/**
 * Import the social feed with import service.
 */
function social_feed_fetcher_cron() {
  \Drupal::service('import_social_feed_service')->import();
}

/**
 * Ensure all post text links are hyperlinks.
 */
function social_feed_fetcher_linkify($text) {
  $rexProtocol = '(https?://)?';
  $rexDomain = '((?:[-a-zA-Z0-9]{1,63}\.)+[-a-zA-Z0-9]{2,63}|(?:[0-9]{1,3}\.){3}[0-9]{1,3})';
  $rexPort = '(:[0-9]{1,5})?';
  $rexPath = '(/[!$-/0-9:;=@_\':;!a-zA-Z\x7f-\xff]*?)?';
  $rexQuery = '(\?[!$-/0-9:;=@_\':;!a-zA-Z\x7f-\xff]+?)?';
  $rexFragment = '(#[!$-/0-9:;=@_\':;!a-zA-Z\x7f-\xff]+?)?';

  $text = preg_replace_callback("&\\b$rexProtocol$rexDomain$rexPort$rexPath$rexQuery$rexFragment(?=[?.!,;:\"]?(\s|$))&",
    function ($match) {
      // Prepend http:// if no protocol specified.
      $completeUrl = $match[1] ? $match[0] : "http://{$match[0]}";

      return '<a href="' . $completeUrl . '">'
        . $match[2] . $match[3] . $match[4] . '</a>';
    }, htmlspecialchars($text));
  return $text;
}

/**
 * Save external file.
 *
 * @param $filename
 * @param $path
 *
 * @return int
 */
function social_feed_fetcher_save_file($filename, $path) {
  $name = basename($filename);
  $data = file_get_contents($filename);
  $uri = $path . '/' . $name;
  file_prepare_directory($path, FILE_CREATE_DIRECTORY);
  $uri = explode('?', $uri);
  if (!file_save_data($data, $uri[0], FILE_EXISTS_REPLACE)) {
    return 0;
  }
  return file_save_data($data, $uri[0], FILE_EXISTS_REPLACE)->id();
}
